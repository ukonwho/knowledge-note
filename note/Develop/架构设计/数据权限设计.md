# 数据权限设计

## Role

```
As a senior Java language development engineer, proficient in the Spring Boot development framework, your are my assistant.
```

## 一、管理系统菜单权限、功能权限、数据权限的整体设计方案
整体设计方案如下：

1. 菜单权限设计
菜单权限是控制用户能否访问某个菜单的权限。在设计菜单权限时，需要考虑以下几点：

- 菜单权限应该与角色相关联，即不同的角色可以访问不同的菜单。
- 菜单权限应该具有继承性，即如果一个角色有某个菜单的访问权限，那么该角色下属的所有用户也应该有该菜单的访问权限。
- 菜单权限应该支持动态配置，即管理员可以根据需要随时修改某个角色的菜单权限。
- 菜单权限应该支持多级菜单，即菜单可以有子菜单，子菜单可以再有子菜单。

2. 功能权限设计
功能权限是控制用户能否执行某个操作的权限。在设计功能权限时，需要考虑以下几点：

- 功能权限应该与角色相关联，即不同的角色可以执行不同的操作。
- 功能权限应该具有继承性，即如果一个角色有某个操作的执行权限，那么该角色下属的所有用户也应该有该操作的执行权限。
- 功能权限应该支持动态配置，即管理员可以根据需要随时修改某个角色的功能权限。
- 功能权限应该与菜单权限相关联，即某个操作的执行权限应该与该操作所在的菜单的访问权限相关联。

3. 数据权限设计
数据权限是控制用户能否访问某个数据的权限。在设计数据权限时，需要考虑以下几点：

- 数据权限应该与角色相关联，即不同的角色可以访问不同的数据。
- 数据权限应该具有继承性，即如果一个角色有某个数据的访问权限，那么该角色下属的所有用户也应该有该数据的访问权限。
- 数据权限应该支持动态配置，即管理员可以根据需要随时修改某个角色的数据权限。
- 数据权限应该与功能权限相关联，即某个操作所能访问的数据应该与该操作的执行权限相关联。

以上是菜单权限、功能权限、数据权限的整体设计方案，具体实现需要根据具体业务需求进行设计。

## 二、使用apache shiro 该如何设计
在 Apache Shiro 框架下，可以使用 Shiro-Web 模块来实现菜单权限、功能权限、数据权限的设计。以下是具体设计方案：

1. 菜单权限设计
在 Shiro-Web 模块中，可以通过配置 Shiro Filter 来实现菜单权限的控制。具体实现步骤如下：

- 在 Shiro Filter 配置中，通过配置 URL 模式和角色之间的关系来控制菜单访问权限。

- 在数据库中维护菜单路径与角色之间的关系，管理员可以通过修改数据库中的数据来动态配置菜单权限。

2. 功能权限设计
在 Shiro-Web 模块中，可以通过配置 Shiro AOP 来实现功能权限的控制。具体实现步骤如下：

- 在方法上使用 Shiro AOP 注解，指定需要执行该方法的用户需要具备的权限。

- 在数据库中维护角色与权限之间的关系，管理员可以通过修改数据库中的数据来动态配置功能权限。

3. 数据权限设计
在 Shiro-Web 模块中，可以通过配置 Shiro Filter 和 Shiro AOP 来实现数据权限的控制。具体实现步骤如下：

- 在 Shiro Filter 配置中，通过配置 URL 模式和角色之间的关系来控制数据访问权限。

- 在方法上使用 Shiro AOP 注解和自定义的过滤器，对返回结果和传入参数进行过滤。

- 在数据库中维护角色与数据之间的关系，管理员可以通过修改数据库中的数据来动态配置数据权限。

除了 Shiro-Web 模块，还可以使用其他的 Shiro 模块来实现权限控制，如 Shiro-Spring、Shiro-Core 等。需要根据具体业务需求来选择合适的模块。

## 三、请进一步讲解一下数据权限这块的设计，包含数据结构、配置，以及举例说明
假设有一个订单管理系统，管理员需要对不同角色的用户进行数据权限控制，以保护订单数据的安全性。

1. 数据结构设计
在数据库中设计一个角色数据权限表，表结构如下：

| 角色ID | 数据类型 | 数据ID |
| :----- | :------: | -----: |
| role1  |  order   | order1 |
| role1  |  order   | order2 |
| role2  |  order   | order1 |

2. 配置设计
在 Shiro Filter 配置中，指定 URL 模式和角色之间的关系，以控制用户能否访问某个数据。具体实现步骤如下：

```
filterChainDefinitionMap.put("/order/**", "roles[role1]");
```

在 Shiro AOP 配置中，定义一个自定义的过滤器，根据当前用户的角色和数据权限来过滤返回结果和传入参数。具体实现步骤如下：

```
@RequiresPermissions(value = "order:view")
@MyDataFilter("order")
public List<Order> queryOrderList() {
    // 查询订单列表
}
```
其中，@MyDataFilter 是自定义的过滤器注解，"order" 表示数据类型为订单。在该方法中，只有角色为 role1 的用户可以访问 order1 和 order2 的订单数据。角色为 role2 的用户只能访问 order1 的订单数据。

这样就实现了数据权限的控制。管理员可以根据具体业务需求在数据库中动态配置角色与数据之间的关系，以实现数据权限的动态控制。



将维度整合到一个数据权限表里面设计，可以更加灵活地实现数据权限的控制。该表可以包含以下几个字段：

- 角色 ID：角色的唯一标识符。
- 数据类型：数据的类型，如用户、订单、商品等。
- 维度类型：维度的类型，如机构、地域、时间等。
- 维度 ID：维度的唯一标识符。
- 数据 ID：数据的唯一标识符。

下面是一个例子：

| 角色ID | 数据类型 | 维度类型 | 维度ID | 数据ID |
| :----- | :------: | -------: | ------ | ------ |
| role1  |   user   |      org | org1   | user1  |
| role1  |   user   |      org | org2   | user2  |
| role1  |  order   |     time | 2022Q1 | order1 |
| role1  |  order   |     time | 2022Q2 | order2 |
| role2  | product  |     area | area1  | prod1  |
| role2  | product  |     area | area2  | prod2  |
| role2  | product  |     area | area2  | prod3  |
